@model IEnumerable<ATable.Models.ProduitPanier>

@{
    ViewBag.Title = "Panier";

    string isConnected = Session["Utilisateur"] != null ? "true" : "false";

}


<div class="container body-content">
    <div class="row valign-wrapper center-align">
        <div class="col s12 m10 offset-m1 valign">
            <h2 class="courgette">Récapitulatif de votre panier</h2>
            <table class="table table-panier">
                @if (Model != null && Model.Count() > 0)
                {
                    foreach (var item in Model)
                    {
                        <tr class="card-panel">

                            <td>
                                @Html.DisplayFor(modelItem => item.Photo)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.Nom)
                            </td>

                            <td class="hide-on-small-and-down">
                                @Html.DisplayFor(modelItem => item.Description)
                            </td>
                            <td>
                                @(item.Prix * item.Quantite)&nbsp;€
                            </td>
                            <td class="center-align">
                                <button class="btn-floating btn-small waves-effect waves-light red add" data-idproduit=@item.IdProduit><i class="material-icons">add</i></button>
                            </td>
                            <td class="center-align">
                                <span id="@item.IdProduit">@item.Quantite</span>
                            </td>
                            <td class="center-align">
                                <button class="btn-floating btn-small waves-effect waves-light red delete" data-idproduit=@item.IdProduit><i class="material-icons">remove</i></button>
                            </td>
                        </tr>

                    }
                    <tr class="card-panel">
                        <td></td>
                        <td class="hide-on-small-and-down"></td>
                        <td class="right"><strong>TOTAL :</strong></td>
                        <td><span class="total"></span>&nbsp;€</td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                }
            </table>

            <a class="waves-effect waves-light btn-large col s12 m6 offset-m3" id="payer">
                <i class="fas fa-check fa-lg"></i>&nbsp;&nbsp;Payer&nbsp;&nbsp;
            </a>
        </div>
    </div>
</div>

<!--Modal connexion-->
<div id="modal1" class="modal">
    <div class="modal-content center">
        <h4>Connexion</h4>

        <div class="row">
            <div class="input-field col s12 m6 offset-m3">
                <i class="material-icons prefix">
                    account_circle
                </i>
                <input type="text" />
                <label for="Matricule">N° de Matricule</label>
            </div>
        </div>

        <div class="row">
            <div class="input-field col s12 m6 offset-m3">
                <i class="material-icons prefix">
                    lock_outline
                </i>
                <input type="password" />
                <label for="Password">Mot de Passe</label>
            </div>
        </div>

        <div class="row center">
            <a href="#">Mot de passe oublié ?</a>
        </div>

        <div class="row center">
            <input type="submit" value="Se connecter" class="btn btn-default" />
        </div>

        <div class="modal-footer">
            <div class="row center-align">
                Vous n'avez pas de compte ?<a href="@Url.Action("Create", "Utilisateurs")">&nbsp;Inscription</a>
            </div>
        </div>

        @*<div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-green btn-flat" id="btnConnexion">Connexion</a>
        </div>*@
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            $("#payer").click(function () {
                if (@isConnected) {
                    SaveCommandeWS();
                } else {
                    $('.modal').openModal();
                }
            });
        });

        function SaveCommandeWS() {
            var data = { 'idSession': '@Session.SessionID' };

            $.ajax({
                    url: '@Url.Action("SaveCommande", "WebService")',
                    type: 'POST',
                    data: JSON.stringify(data),
                    contentType: 'application/json; charset=utf-8',
                    DataType: 'json',
                    success: function (data) {

                        @*@Url.Action("Scooter", "");*@
                        //show message success
                    },
                    error: function () {
                        //show message error
                        alert('Error');
                    }
            });
        }

        @*function LoginWS() {
            var matricule = $('#matricule').val();
            var password = $('#password').val();

            if (matricule != "" && password != "") {

                var data = { 'idSession': '@Session.SessionID', 'matricule': matricule, 'password': password };

                $.ajax({
                        url: '@Url.Action("Login", "WebService")',
                        type: 'POST',
                        data: JSON.stringify(data),
                        contentType: 'application/json; charset=utf-8',
                        DataType: 'json',
                    success: function (data) {
                        if (data.error == 1) {
                           $('.modal').close();
                        }
                            //show message success
                        },
                        error: function () {
                            //show message error
                            alert('Error');
                        }
                });
            }
        }*@

        $(".add").click(function () {
                 var idProduit = $(this).data('idproduit');

                 var Qte = $('#'+idProduit).html();

            var data = { 'idProduit': idProduit, 'idSession': '@Session.SessionID' };

                $.ajax({
                    url: '@Url.Action("AddProduit", "WebService")',
                    type: 'POST',
                    data: JSON.stringify(data),
                    contentType: 'application/json; charset=utf-8',
                    DataType: 'json',
                    success: function (data) {
                        var Quantite = parseInt(Qte) + 1;
                        $('#' + idProduit).html(Quantite);
                        $('.total').html(data.total);
                    },
                    error: function () {
                        alert('Error');
                    }
                });
            });

            $(".delete").click(function () {
                 var idProduit = $(this).data('idproduit');

                 var Qte = $('#'+idProduit).html();

            var data = { 'idProduit': idProduit, 'idSession': '@Session.SessionID' };

                $.ajax({
                    url: '@Url.Action("DeleteProduit", "WebService")',
                    type: 'POST',
                    data: JSON.stringify(data),
                    contentType: 'application/json; charset=utf-8',
                    DataType: 'json',
                    success: function (data) {
                        var Quantite = parseInt(Qte) - 1;
                        $('#' + idProduit).html(Quantite);
                        $('.total').html(data.total);
                    },
                    error: function () {
                        alert('Error');
                    }
                });
            });
    </script>
}
